#!/bin/bash

AMUSERID=${5}
AM_USER="uid=${AMUSERID},ou=People,dc=openam,dc=forgerock,dc=org"
COOKIENAME="iPlanetDirectoryPro"
ENVIRONMENT=${7}

echo ${6} > /tmp/pwd.txt
chmod 400 /tmp/pwd.txt

# Create authentication token
token=`curl -X POST -H "X-OpenAM-Username: ${AMUSERID}" -H "X-OpenAM-Password: ${6}" -H "Content-Type: application/json" -H "Accept-API-Version: resource=2.1" -d '{}' -s -k "${2}/json/realms/root/authenticate?authIndexType=service&authIndexValue=adminconsoleservice" | awk -F: '{print $2}' | awk -F, '{print $1}' | tr -d '"'`

oauth2data='{"coreOAuth2Config":{"refreshTokenLifetime":604800,"accessTokenLifetime":3600,"usePolicyEngineForScope":true,"codeLifetime":120,"issueRefreshTokenOnRefreshedToken":false,"issueRefreshToken":true,"accessTokenModificationScript":"PwCAccessToken","statelessTokensEnabled":true},"coreOIDCConfig":{"supportedIDTokenEncryptionMethods":["A256GCM","A192GCM","A128GCM","A128CBC-HS256","A192CBC-HS384","A256CBC-HS512"],"jwtTokenLifetime":3600,"supportedClaims":["phone_number|Phone number"," pwcGlobalGradeAbbreviatedName|pwcGlobalGradeAbbreviatedName"," employeetype|PwCemployeeStatus INAB"," family_name|Family name"," pwcLocalLOSLevel2|pwcLocalLOSLevel2"," ms-ds-consistency-guid|ms-ds-consistency-guid"," name|Full name"," pwcstreet4|PwCstreet4"," windowsaccountname|pwcObjectSID"," postalcode|postalCode"," pwclocationcode|PwClocationcode"," street|street"," jobtitle|jobtitle"," pwcLocalLOSLevel4|pwcLocalLOSLevel4"," locale|Locale","PwCLegacyEmployeeNumber|PwCLegacyEmployeeNumber","upwcdepartment|uPwCdepartmentpwc","street3|PwCstreet3","upwcjobtitle|upwcjobtitle","pwcLocalLOSLevel1|pwcLocalLOSLevel1","middlename|PwCmiddleName"," PwChrGivenName|PwChrGivenName"," uPwCLegacyEmployeeNumber|uPwCLegacyEmployeeNumber"," PwCStaffClass|PwCStaffClass"," locality|PwCcity"," given_name|Given name"," pwcGlobalGradeName|pwcGlobalGradeName"," pwcnotesdnabbreviated|PwCnotesDNAbbreviated"," email|Email address"," profile|Your personal information"," address|Postal address"," stateorprovince|State or province"," pwcLocalLOSLevel3|pwcLocalLOSLevel3"," pwcstreet2|PwCstreet2"," phone|phone"," zoneinfo|Time zone"," pwcWorkerID|pwcWorkerID","mobile|mobile"],"supportedIDTokenEncryptionAlgorithms":["RSA-OAEP","RSA-OAEP-256","A128KW","A256KW","RSA1_5","dir","A192KW"],"supportedIDTokenSigningAlgorithms":["PS384","RS384","ES384","HS256","HS512","ES256","RS256","HS384","ES512","PS256","PS512","RS512"],"oidcClaimsScript":"PWCOIDCCLAIMS"},"advancedOAuth2Config":{"supportedScopes":["openid|"," stateorprovince|state or province"," pwcGlobalGradeAbbreviatedName|pwcGlobalGradeAbbreviatedName"," PwChrFamilyName|PwChrFamilyName"," uid|uid"," countrycode|countrycode"," ms-ds-consistency-guid|ms-ds-consistency-guid"," postalcode|postalCode"," pwclocationcode|PwClocationcode"," street|street"," organization|organization"," staffnumber|staffnumber"," stateorprovince|stateorprovince"," jobtitle|jobtitle"," LOS|LOS"," PwClos|PwClos"," groups|groups"," pwcstreet3|PwCstreet3"," country|country"," PwChrGivenName|PwChrGivenName"," employeetype|employeetype"," address|Your postal address"," locality|PwCcity"," phone|Your telephone number(s)"," pwcGlobalGradeName|pwcGlobalGradeName"," profile|Your personal information"," pwcstreet2|PwCstreet2",""," preferredLanguage|preferredLanguage"," PwCassignedofficecode|PwCassignedofficecode"," pwcWorkerID|pwcWorkerID"," mobile|mobile"," GlobalGradeCode|GlobalGradeCode"," businessunit|businessunit"," cloudEmail|cloudEmail"," pwcstreet4|PwCstreet4"," windowsaccountname|pwcObjectSID"," offline_access"," windowsaccountname|windowsaccountname"," upwcdepartment|uPwCdepartment"," pwcPartyID|pwcPartyID"," upwcjobtitle|upwcjobtitle"," middlename|PwCmiddleName"," notesDN|notesDN"," employeeNumber|employeeNumber"," email|Your email address"," preferredMail|preferredMail"," PwCStaffClass|PwCStaffClass"," locality|locality"," pwcnotesdnabbreviated|PwCnotesDNAbbreviated"," preferredMailcostcenter|costcenter"," PwCPPI|PwCPPI"," employeetype|PwCemployeeStatus INABopenid"],"codeVerifierEnforced":"false","tokenSigningAlgorithm":"HS256","authenticationAttributes":["uid","mail"],"passwordGrantAuthService":"[Empty]","defaultScopes":["address","phone","openid","offline_access","profile","email"],"scopeImplementationClass":"com.pwc.pwcidentity.openam.oauth2.attributemapper.PwCCustomScopeValidator","responseTypeClasses":["code|org.forgerock.oauth2.core.AuthorizationCodeResponseTypeHandler","id_token|org.forgerock.openidconnect.IdTokenResponseTypeHandler","device_code|org.forgerock.oauth2.core.TokenResponseTypeHandler","token|org.forgerock.oauth2.core.TokenResponseTypeHandler"],"tlsCertificateBoundAccessTokensEnabled":true,"moduleMessageEnabledInPasswordGrant":false,"tokenEncryptionEnabled":false,"tokenCompressionEnabled":false,"grantTypes":["implicit","urn:ietf:params:oauth:grant-type:saml2-bearer","refresh_token","password","client_credentials","urn:ietf:params:oauth:grant-type:device_code","authorization_code","urn:openid:params:grant-type:ciba","urn:ietf:params:oauth:grant-type:uma-ticket","urn:ietf:params:oauth:grant-type:jwt-bearer"],"displayNameAttribute":"cn","customLoginUrlTemplate":"https://login.myforgerock.com/login/?goto=${goto}<#if acrValues??>&acr_values=${acrValues}</#if><#if realm??>&realm=${realm}</#if><#if module??>&module=${module}</#if><#if service??>&service=${service}</#if><#if locale??>&locale=${locale}</#if>","supportedSubjectTypes":["public"]},"advancedOIDCConfig":{"storeOpsTokens":true,"defaultACR":[],"supportedRequestParameterEncryptionEnc":["A256GCM","A192GCM","A128GCM","A128CBC-HS256","A192CBC-HS384","A256CBC-HS512"],"claimsParameterSupported":true,"amrMappings":{},"supportedUserInfoEncryptionEnc":["A256GCM","A192GCM","A128GCM","A128CBC-HS256","A192CBC-HS384","A256CBC-HS512"],"alwaysAddClaimsToToken":true,"supportedUserInfoSigningAlgorithms":["ES384","HS256","HS512","ES256","RS256","HS384","ES512"],"supportedRequestParameterEncryptionAlgorithms":["RSA-OAEP","RSA-OAEP-256","A128KW","A256KW","RSA1_5","dir","A192KW"],"authorisedOpenIdConnectSSOClients":["openidm"],"idTokenInfoClientAuthenticationEnabled":false,"supportedRequestParameterSigningAlgorithms":["PS384","RS384","ES384","HS256","HS512","ES256","RS256","HS384","ES512","PS256","PS512","RS512"],"supportedUserInfoEncryptionAlgorithms":["RSA-OAEP","RSA-OAEP-256","A128KW","A256KW","RSA1_5","dir","A192KW"],"supportedTokenEndpointAuthenticationSigningAlgorithms":["PS384","RS384","ES384","HS256","HS512","ES256","RS256","HS384","ES512","PS256","PS512","RS512"],"loaMapping":{"2":"MFA","4":"CERT","6":"pwc-cert"}},"clientDynamicRegistrationConfig":{"dynamicClientRegistrationSoftwareStatementRequired":false,"dynamicClientRegistrationScope":"dynamic_client_registration","requiredSoftwareStatementAttestedAttributes":["redirect_uris"],"generateRegistrationAccessTokens":true,"allowDynamicRegistration":true},"cibaConfig":{"supportedCibaSigningAlgorithms":["ES256","PS256"],"cibaAuthReqIdLifetime":600,"cibaMinimumPollingInterval":2},"consent":{"enableRemoteConsent":false,"supportedRcsRequestSigningAlgorithms":["PS384","RS384","ES384","HS256","HS512","ES256","RS256","HS384","ES512","PS256","PS512","RS512"],"supportedRcsResponseSigningAlgorithms":["PS384","RS384","ES384","HS256","HS512","ES256","RS256","HS384","ES512","PS256","PS512","RS512"],"clientsCanSkipConsent":true,"supportedRcsRequestEncryptionAlgorithms":["RSA-OAEP","RSA-OAEP-256","A128KW","RSA1_5","A256KW","dir","A192KW"],"supportedRcsResponseEncryptionMethods":["A256GCM","A192GCM","A128GCM","A128CBC-HS256","A192CBC-HS384","A256CBC-HS512"],"supportedRcsRequestEncryptionMethods":["A256GCM","A192GCM","A128GCM","A128CBC-HS256","A192CBC-HS384","A256CBC-HS512"],"supportedRcsResponseEncryptionAlgorithms":["RSA-OAEP","RSA-OAEP-256","A128KW","A256KW","RSA1_5","dir","A192KW"]},"deviceCodeConfig":{"devicePollInterval":5,"deviceCodeLifetime":300},"_type":{"_id":"oauth-oidc","name":"OAuth2 Provider","collection":false}}'

# OAuth2 Proviider
pwcoauth2=`curl -X PUT -H "${COOKIENAME}:${token}" -H "Content-Type: application/json" -H "Accept-API-Version: resource=1.0" -d "${oauth2data}" -s -k "${2}/json/realms/root/realms/pwc/realm-config/services/oauth-oidc"`

pwcsandboxoauth2=`curl -X PUT -H "${COOKIENAME}:${token}" -H "Content-Type: application/json" -H "Accept-API-Version: resource=1.0" -d "${oauth2data}" -s -k "${2}/json/realms/root/realms/pwc/realms/sandbox/realm-config/services/oauth-oidc"`

# clean up
rm -rf /tmp/pwd.txt
